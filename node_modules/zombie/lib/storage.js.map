{"version":3,"sources":["storage.js"],"names":[],"mappings":"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","file":"storage.js","sourcesContent":["// See [Web Storage](http://dev.w3.org/html5/webstorage/)\nconst DOM = require('./dom');\n\n\n// Implementation of the StorageEvent.\nclass StorageEvent extends DOM.Event {\n\n  constructor(storage, url, key, oldValue, newValue) {\n    super('storage');\n    this._storage   = storage;\n    this._url       = url;\n    this._key       = key;\n    this._oldValue  = oldValue;\n    this._newValue  = newValue;\n  }\n\n  get url() {\n    return this._url;\n  }\n  get storageArea() {\n    return this._storage;\n  }\n  get key() {\n    return this._key;\n  }\n  get oldValue() {\n    return this._oldValue;\n  }\n  get newValue() {\n    return this._newValue;\n  }\n}\n\n\n// Storage area. The storage area is shared by multiple documents of the same\n// origin. For session storage, they must also share the same browsing context.\nclass StorageArea {\n\n  constructor() {\n    this._items     = {};\n    this._storages  = [];\n  }\n\n  // Fire a storage event. Fire in all documents that share this storage area,\n  // except for the source document.\n  _fire(source, key, oldValue, newValue) {\n    for (let [storage, window] of this._storages) {\n      if (storage === source)\n        continue;\n      const event = new StorageEvent(storage, window.location.href, key, oldValue, newValue);\n      window.dispatchEvent(event);\n    }\n  }\n\n  // Return number of key/value pairs.\n  get length() {\n    return Object.keys(this._items).length;\n  }\n\n  // Get key by ordinal position.\n  key(index) {\n    return Object.keys(this._items)[index];\n  }\n\n  // Get value from key\n  get(key) {\n    return this._items[key] || null;\n  }\n\n  // Set the value of a key. We also need the source storage (so we don't send\n  // it a storage event).\n  set(source, key, value) {\n    const oldValue = this._items[key];\n    this._items[key] = value;\n    this._fire(source, key, oldValue, value);\n  }\n\n  // Remove the value at the key. We also need source storage (see set above).\n  remove(source, key) {\n    const oldValue = this._items[key];\n    delete this._items[key];\n    this._fire(source, key, oldValue);\n  }\n\n  // Remove all values. We also need source storage (see set above).\n  clear(source) {\n    this._items = {};\n    this._fire(source);\n  }\n\n  get pairs() {\n    return Object.keys(this._items).map(key => [key, this._items[key]] );\n  }\n\n  toString() {\n    return Object.keys(this._items)\n      .map(key => `${key} = ${this._items[key]}` )\n      .join('\\n');\n  }\n\n  // Associate local/sessionStorage and window with this storage area. Used when firing events.\n  associate(storage, window) {\n    this._storages.push([storage, window]);\n  }\n\n}\n\n\n// Implementation of the Storage interface, used by local and session storage.\nclass Storage {\n\n  constructor(area) {\n    this._area = area;\n  }\n\n  // ### storage.length => Number\n  //\n  // Returns the number of key/value pairs in this storage.\n  get length() {\n    return this._area.length;\n  }\n\n  // ### storage.key(index) => String\n  //\n  // Returns the key at this position.\n  key(index) {\n    return this._area.key(index);\n  }\n\n  // ### storage.getItem(key) => Object\n  //\n  // Returns item by key.\n  getItem(key) {\n    return this._area.get(key.toString());\n  }\n\n  // ### storage.setItem(key, Object)\n  //\n  // Add item or change value of existing item.\n  setItem(key, value) {\n    this._area.set(this, key.toString(), value);\n  }\n\n  // ### storage.removeItem(key)\n  //\n  // Remove item.\n  removeItem(key) {\n    this._area.remove(this, key.toString());\n  }\n\n  // ### storage.clear()\n  //\n  // Remove all items.\n  clear() {\n    this._area.clear(this);\n  }\n\n  // Dump to a string, useful for debugging.\n  dump(output = process.stdout) {\n    return this._area.dump(output);\n  }\n\n}\n\n\n\n\n// Combined local/session storage.\nclass Storages {\n\n  constructor() {\n    this._locals    = {};\n    this._sessions  = {};\n  }\n\n  // Return local Storage based on the document origin (hostname/port).\n  local(host) {\n    if (!this._locals[host])\n      this._locals[host] = new StorageArea();\n    return new Storage(this._locals[host]);\n  }\n\n  // Return session Storage based on the document origin (hostname/port).\n  session(host) {\n    if (!this._sessions[host])\n      this._sessions[host] = new StorageArea();\n    return new Storage(this._sessions[host]);\n  }\n\n  // Extend window with local/session storage support.\n  extend(window) {\n    const storages = this;\n    window.StorageEvent = StorageEvent;\n    Object.defineProperties(window, {\n      localStorage: {\n        get() {\n          const { document } = this;\n          if (!document._localStorage)\n            document._localStorage = storages.local(document.location.host);\n          return document._localStorage;\n        }\n      },\n\n      sessionStorage: {\n        get() {\n          const { document } = this;\n          if (!document._sessionStorage)\n            document._sessionStorage = storages.session(document.location.host);\n          return document._sessionStorage;\n        }\n      }\n    });\n  }\n\n  // Used to dump state to console (debuggin)\n  dump(output = process.stdout) {\n    for (let domain of this._locals) {\n      let area = this._locals[domain];\n      output.write(`${domain} local:\\n`);\n      for (let [name, value] of area.pairs)\n        output.write(`  ${name} = ${value}\\n`);\n    }\n    for (let domain of this._sessions) {\n      let area = this._sessions[domain];\n      output.push(`${domain} session:\\n`);\n      for (let [name, value] of area.pairs)\n        output.write(`  ${name} = ${value}\\n`);\n    }\n  }\n\n  // browser.saveStorage uses this\n  save() {\n    const serialized = [`# Saved on ${new Date().toISOString()}`];\n    for (let domain of this._locals) {\n      let area = this._locals[domain];\n      let pairs = area.pairs;\n      if (pairs.length) {\n        serialized.push(`${domain} local:`);\n        for (let [name, value] of area.pairs)\n          serialized.push(`  ${escape(name)} = ${escape(value)}`);\n      }\n    }\n    for (let domain of this._sessions) {\n      let area = this._sessions[domain];\n      let pairs = area.pairs;\n      if (pairs.length) {\n        serialized.push(`${domain} session:`);\n        for (let [name, value] of area.pairs)\n          serialized.push(`  ${escape(name)} = ${escape(value)}`);\n      }\n    }\n    return serialized.join(`\\n`) + `\\n`;\n  }\n\n  // browser.loadStorage uses this\n  load(serialized) {\n    let storage = null;\n    for (let item of serialized.split(/\\n+/)) {\n      if (item[0] === '#' || item === '')\n        continue;\n      if (item[0] === ' ') {\n        const [key, value] = item.split('=');\n        if (storage)\n          storage.setItem(unescape(key.trim()), unescape(value.trim()));\n        else\n          throw new Error('Must specify storage type using local: or session:');\n      } else {\n        const [domain, type] = item.split(' ');\n        if (type === 'local:')\n          storage = this.local(domain);\n        else if (type === 'session:')\n          storage = this.session(domain);\n        else\n          throw new Error(`Unkown storage type ${type}`);\n      }\n    }\n  }\n}\n\n\nmodule.exports = Storages;\n\n"],"sourceRoot":"/source/"}